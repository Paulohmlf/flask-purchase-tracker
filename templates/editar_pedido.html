{% extends "base.html" %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 0 auto; border-top: 6px solid #f39c12;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="margin: 0; border: none; font-size: 1.8rem; color: #2c3e50;">‚úèÔ∏è Editando Pedido #{{ pedido.id }}</h1>
        <a href="{{ url_for('dashboard') }}" style="color: #c0392b; font-weight: bold; text-decoration: none;" aria-label="Cancelar e voltar para dashboard">
            ‚úñ Cancelar
        </a>
    </div>
    
    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="itens_para_remover" id="itens_para_remover" value="">

        <section style="background-color: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #ffeeba;">
            <label for="id_status" style="margin-top: 0; color: #856404;">Qual a situa√ß√£o atual?</label>
            <select id="id_status" name="status" style="font-weight: bold; font-size: 1.2rem; border-color: #f39c12;" onchange="verificarStatusEntrega()">
                <option value="Aguardando Aprova√ß√£o" {% if pedido.status_compra == 'Aguardando Aprova√ß√£o' %}selected{% endif %}>üü° Aguardando Aprova√ß√£o</option>
                <option value="Or√ßamento" {% if pedido.status_compra == 'Or√ßamento' %}selected{% endif %}>üü£ Or√ßamento</option>
                <option value="Confirmado" {% if pedido.status_compra == 'Confirmado' %}selected{% endif %}>üîµ Confirmado</option>
                <option value="Em Tr√¢nsito" {% if pedido.status_compra == 'Em Tr√¢nsito' %}selected{% endif %}>üöö Em Tr√¢nsito</option>
                <option value="Entregue Parcialmente" {% if pedido.status_compra == 'Entregue Parcialmente' %}selected{% endif %}>üì¶ Entregue Parcialmente</option>
                <option value="Entregue Totalmente" {% if pedido.status_compra == 'Entregue Totalmente' %}selected{% endif %}>‚úÖ Entregue Totalmente</option>
            </select>

            <div id="bloco-entrega" style="display: none; margin-top: 20px; border-top: 2px dashed #d35400; padding-top: 20px;">
                <h3 style="margin-top: 0; color: #d35400;">üìã Confer√™ncia de Recebimento</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label>Data Real do Recebimento:</label>
                        <input type="date" name="data_entrega_real" value="{{ pedido.data_entrega_real or '' }}" id="id_data_real">
                    </div>
                    
                    <div>
                        <label>A entrega foi Perfeita? (OTIF)</label>
                        <select name="entrega_conforme" id="id_conforme" onchange="toggleDetalhesErro()">
                            <option value="" {% if pedido.entrega_conforme is none %}selected{% endif %}>-- Selecione --</option>
                            <option value="1" {% if pedido.entrega_conforme == 1 %}selected{% endif %}>‚úÖ Sim, tudo 100%</option>
                            <option value="0" {% if pedido.entrega_conforme == 0 %}selected{% endif %}>‚ùå N√£o (Teve problema)</option>
                        </select>
                    </div>
                </div>

                <div id="div-erro-entrega" style="display: none; margin-top: 15px;">
                    <label for="id_detalhes_entrega" style="color: #c0392b;">O que deu errado? (Atraso, Avaria, Falta...)</label>
                    <textarea name="detalhes_entrega" id="id_detalhes_entrega" rows="2" style="width: 100%; border: 1px solid #c0392b; background: #fff5f5;">{{ pedido.detalhes_entrega or '' }}</textarea>
                </div>
            </div>
        </section>

        <section style="background-color: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #e9ecef;">
            <h2 style="color: var(--azul-acao); margin-top: 0; font-size: 1.4rem;">üì¶ Itens do Pedido</h2>
            
            <div style="display: grid; grid-template-columns: 3fr 1fr 1fr 1fr 0.5fr; gap: 10px; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.9rem;">
                <div>Descri√ß√£o</div>
                <div>Qtd</div>
                <div>Unid.</div>
                <div>Valor Unit. (R$)</div>
                <div></div>
            </div>

            <div id="lista-itens">
                {% for item in itens %}
                <div class="linha-item" style="display: grid; grid-template-columns: 3fr 1fr 1fr 1fr 0.5fr; gap: 10px; margin-bottom: 10px; align-items: center;">
                    <input type="hidden" name="item_id[]" value="{{ item.id }}">
                    
                    <input type="text" name="nome_item[]" value="{{ item.nome_item }}" required style="font-weight: bold;" aria-label="Descri√ß√£o do Item">
                    <input type="number" name="qtd[]" value="{{ item.quantidade }}" required min="1" style="text-align: center;" aria-label="Quantidade">
                    
                    <select name="unidade[]" style="padding: 10px;" aria-label="Unidade de Medida">
                        <option value="UN" {% if item.unidade_medida == 'UN' %}selected{% endif %}>UN</option>
                        <option value="CX" {% if item.unidade_medida == 'CX' %}selected{% endif %}>CX</option>
                        <option value="PCT" {% if item.unidade_medida == 'PCT' %}selected{% endif %}>PCT</option>
                        <option value="KG" {% if item.unidade_medida == 'KG' %}selected{% endif %}>KG</option>
                        <option value="M" {% if item.unidade_medida == 'M' %}selected{% endif %}>M</option>
                        <option value="L" {% if item.unidade_medida == 'L' %}selected{% endif %}>L</option>
                    </select>

                    <input type="number" step="0.01" name="valor[]" value="{{ item.valor_unitario or '' }}" placeholder="0,00" style="text-align: right;">

                    <button type="button" onclick="removerItemExistente(this, '{{ item.id }}')" style="background: #fab1a0; color: #c0392b; padding: 10px; margin: 0;" aria-label="Remover item {{ item.nome_item }}">
                        ‚úñ
                    </button>
                </div>
                {% endfor %}
            </div>

            <button type="button" onclick="adicionarItem()" style="background-color: #3498db; width: 100%; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <span class="material-icons">add_circle</span> Adicionar Outro Item
            </button>
        </section>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
            <div>
                <label for="id_item">T√≠tulo / Resumo do Pedido:</label>
                <input type="text" id="id_item" name="item" value="{{ pedido.item_comprado }}" required style="background: #f9f9f9; font-weight: bold;">
                
                <label for="id_fornecedor">Fornecedor:</label>
                <input type="text" id="id_fornecedor" name="fornecedor" value="{{ pedido.fornecedor }}" required style="background: #f9f9f9;">
                
                <label for="id_categoria">Categoria Principal:</label>
                <input type="text" id="id_categoria" name="categoria" value="{{ pedido.categoria or '' }}" placeholder="Ex: Material de Escrit√≥rio">
                
                <hr style="margin: 20px 0;">

                <label for="id_solicitacao">N¬∫ Solicita√ß√£o:</label>
                <input type="text" id="id_solicitacao" name="solicitacao" value="{{ pedido.numero_solicitacao }}" required>
                
                <label for="id_orcamento">N¬∫ Or√ßamento:</label>
                <input type="text" id="id_orcamento" name="orcamento" value="{{ pedido.numero_orcamento or '' }}">
                
                <label for="id_pedido">N¬∫ Pedido:</label>
                <input type="text" id="id_pedido" name="pedido" value="{{ pedido.numero_pedido or '' }}">
            </div>
            
            <div>
                <label for="id_data_registro" style="color: #d35400;">üìÖ Data de Abertura:</label>
                <input type="date" id="id_data_registro" name="data_registro" value="{{ pedido.data_registro.strftime('%Y-%m-%d') if pedido.data_registro else '' }}">

                <label for="id_data_compra">Data da Compra:</label>
                <input type="date" id="id_data_compra" name="data_compra" value="{{ pedido.data_compra or '' }}">
                
                <label for="id_prazo">Prazo Original:</label>
                <input type="date" id="id_prazo" name="prazo" value="{{ pedido.prazo_entrega or '' }}">
                
                <label for="id_reprogramada" style="color: #d35400;">Nova Data (se atrasou):</label>
                <input type="date" id="id_reprogramada" name="reprogramada" value="{{ pedido.data_entrega_reprogramada or '' }}">
                
                <hr style="margin: 20px 0;">

                <label for="id_nota">Nota Fiscal:</label>
                <input type="text" id="id_nota" name="nota" value="{{ pedido.nota_fiscal or '' }}">
                
                <label for="id_serie">S√©rie:</label>
                <input type="text" id="id_serie" name="serie" value="{{ pedido.serie_nota or '' }}">
                
                <hr style="margin: 20px 0;">
                
                <label for="id_solicitante_real">Solicitante Real (Quem pediu na ponta?):</label>
                <input type="text" id="id_solicitante_real" name="solicitante_real" value="{{ pedido.solicitante_real or '' }}" placeholder="Ex: Jo√£o da Manuten√ß√£o" style="background-color: #f0f7ff;">

                <label for="id_resp_comprador">Comprador Respons√°vel (Sistema):</label>
                <select id="id_resp_comprador" name="resp_comprador">
                    <option value="">-- Selecione o Comprador --</option>
                    {% for u in usuarios %}
                        <option value="{{ u.id }}" {% if pedido.id_comprador_responsavel|string == u.id|string %}selected{% endif %}>
                            {{ u.nome_completo }}
                        </option>
                    {% endfor %}
                </select>
                
                <label for="id_resp_chamado">Respons√°vel pelo Chamado (Sistema):</label>
                <select id="id_resp_chamado" name="resp_chamado">
                    <option value="">-- Selecione o Solicitante --</option>
                    {% for u in usuarios %}
                        <option value="{{ u.id }}" {% if pedido.id_responsavel_chamado|string == u.id|string %}selected{% endif %}>
                            {{ u.nome_completo }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div style="grid-column: 1 / -1;">
                <label for="id_observacao">Coment√°rios / Observa√ß√µes:</label>
                <textarea id="id_observacao" name="observacao" rows="3" style="width: 100%; border: 2px solid #ccc; border-radius: 8px; padding: 10px; font-size: 1rem; margin-top: 8px;">{{ pedido.observacao or '' }}</textarea>
            </div>
        </div>
        
        <section style="margin-top: 30px; background: #e8f5e9; padding: 15px; border-radius: 8px;">
            <h2 style="margin-top: 0; color: var(--verde-sucesso); font-size: 1.1rem; border: none;">Anexos Atuais ({{ anexos|length }})</h2>

            {% if anexos %}
                <div style="margin-bottom: 15px; border: 1px solid #c8e6c9; padding: 10px; background: #f0fff0; border-radius: 6px;">
                    {% for anexo in anexos %}
                        <div style="display: flex; gap: 10px; align-items: center; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #ddd;">
                            <a href="{{ url_for('static', filename='uploads/' + anexo.nome_arquivo) }}" target="_blank" style="font-weight: bold; font-size: 0.95rem;">
                                üìÑ {{ anexo.nome_original }}
                            </a>
                            <button type="button" onclick="return mostrarModal('{{ url_for('excluir_anexo', anexo_id=anexo.id) }}', 'anexo')" style="color: #c0392b; text-decoration: none; background:none; border:none; font-size: 0.9rem; cursor: pointer;" aria-label="Apagar anexo {{ anexo.nome_original }}">
                                üóëÔ∏è Apagar
                            </button>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="color: #666; font-style: italic;">Nenhum arquivo anexado ainda.</div>
            {% endif %}
            
            <h3 style="font-size: 1rem; margin-bottom: 10px; margin-top: 15px;">Adicionar novo(s) arquivo(s):</h3>
            
            <label for="arquivo" style="border: 2px dashed #999; background: white; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; display: block; margin-top: 0;">
                <span class="material-icons" style="font-size: 2rem; color: var(--azul-acao); display: block;">add_circle</span>
                <span id="texto-arquivo-edit" style="font-size: 1.1rem; color: #555;">Toque aqui para escolher novos arquivos</span>
            </label>
            <input type="file" id="arquivo" name="arquivo" accept=".pdf,.jpg,.jpeg,.png" multiple style="display: none;" onchange="mostrarNomeArquivoEdit()">
        </section>

        <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button type="button" onclick="window.location.href='{{ url_for('dashboard') }}'" style="flex: 1; background-color: #95a5a6; margin: 0; color: #1a252f; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                    Cancelar
                </button>
            <button type="submit" style="flex: 2; background: var(--verde-sucesso); margin: 0; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 1rem; color: white;">
                üíæ Salvar Altera√ß√µes
            </button>
        </div>
    </form>
</div>

<template id="template-novo-item">
    <div class="linha-item" style="display: grid; grid-template-columns: 3fr 1fr 1fr 1fr 0.5fr; gap: 10px; margin-bottom: 10px; align-items: center;">
        <input type="hidden" name="item_id[]" value=""> 
        
        <input type="text" name="nome_item[]" placeholder="Nome do Item" required style="font-weight: bold;" aria-label="Descri√ß√£o do Item">
        <input type="number" name="qtd[]" value="1" required min="1" style="text-align: center;" aria-label="Quantidade">
        
        <select name="unidade[]" style="padding: 10px;" aria-label="Unidade de Medida">
            <option value="UN">UN</option>
            <option value="CX">CX</option>
            <option value="PCT">PCT</option>
            <option value="KG">KG</option>
            <option value="M">M</option>
            <option value="L">L</option>
        </select>

        <input type="number" step="0.01" name="valor[]" placeholder="0,00" style="text-align: right;">

        <button type="button" onclick="removerItemNovo(this)" style="background: #fab1a0; color: #c0392b; padding: 10px; margin: 0;" aria-label="Remover item">
            ‚úñ
        </button>
    </div>
</template>

<script>
    function adicionarItem() {
        const container = document.getElementById('lista-itens');
        const template = document.getElementById('template-novo-item');
        const clone = template.content.cloneNode(true);
        container.appendChild(clone);
    }
    function removerItemNovo(btn) { btn.parentElement.remove(); }
    function removerItemExistente(btn, idItem) {
        if(confirm("Tem certeza que deseja remover este item do pedido?")) {
            let inputRemover = document.getElementById('itens_para_remover');
            if (inputRemover.value) { inputRemover.value += "," + idItem; } else { inputRemover.value = idItem; }
            btn.parentElement.remove();
        }
    }
    function mostrarNomeArquivoEdit() {
        var input = document.getElementById('arquivo');
        var texto = document.getElementById('texto-arquivo-edit');
        if (input.files && input.files.length > 0) {
            texto.innerText = "‚úÖ " + input.files.length + " novo(s) arquivo(s) pronto(s) para upload";
            texto.style.color = "var(--verde-sucesso)";
            texto.parentElement.style.borderColor = "var(--verde-sucesso)";
            texto.parentElement.style.backgroundColor = "#e8f5e9";
        }
    }

    // --- NOVA L√ìGICA: GATILHO VISUAL DA ENTREGA ---
    function verificarStatusEntrega() {
        const status = document.getElementById('id_status').value;
        const bloco = document.getElementById('bloco-entrega');
        const dataReal = document.getElementById('id_data_real');
        
        if (status.includes("Entregue")) {
            bloco.style.display = 'block';
            // Se estiver vazio, preenche com data de hoje
            if (!dataReal.value) {
                dataReal.valueAsDate = new Date();
            }
        } else {
            bloco.style.display = 'none';
        }
    }

    function toggleDetalhesErro() {
        const conforme = document.getElementById('id_conforme').value;
        const divErro = document.getElementById('div-erro-entrega');
        
        if (conforme === '0') { // 0 = N√£o (Teve problema)
            divErro.style.display = 'block';
        } else {
            divErro.style.display = 'none';
        }
    }

    // Roda ao carregar para mostrar o bloco se j√° estiver entregue
    document.addEventListener("DOMContentLoaded", verificarStatusEntrega);
</script>

<style>
    @media (max-width: 600px) {
        .linha-item {
            grid-template-columns: 1fr 1fr !important;
            border-bottom: 2px dashed #ddd;
            padding-bottom: 10px;
        }
        .linha-item input[name="nome_item[]"] { grid-column: span 2; }
    }
</style>
{% endblock %}