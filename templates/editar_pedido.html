{% extends "base.html" %}

{% block content %}
<div class="card" style="max-width: 800px; margin: 0 auto; border-top: 6px solid #f39c12;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; border: none;">‚úèÔ∏è Editando Pedido #{{ pedido.id }}</h2>
    </div>
    
    <form method="POST" enctype="multipart/form-data">
        
        <div style="background-color: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #ffeeba;">
            <label style="margin-top: 0; color: #856404;">Qual a situa√ß√£o atual?</label>
            <select name="status" style="font-weight: bold; font-size: 1.2rem; border-color: #f39c12;">
                <option value="Aguardando Aprova√ß√£o" {% if pedido.status_compra == 'Aguardando Aprova√ß√£o' %}selected{% endif %}>üü° Aguardando Aprova√ß√£o</option>
                <option value="Enviado ao Fornecedor" {% if pedido.status_compra == 'Enviado ao Fornecedor' %}selected{% endif %}>üîµ Enviado ao Fornecedor</option>
                <option value="Confirmado" {% if pedido.status_compra == 'Confirmado' %}selected{% endif %}>üîµ Confirmado</option>
                <option value="Em Tr√¢nsito" {% if pedido.status_compra == 'Em Tr√¢nsito' %}selected{% endif %}>üöö Em Tr√¢nsito</option>
                <option value="Entregue Parcialmente" {% if pedido.status_compra == 'Entregue Parcialmente' %}selected{% endif %}>üì¶ Entregue Parcialmente</option>
                <option value="Entregue Totalmente" {% if pedido.status_compra == 'Entregue Totalmente' %}selected{% endif %}>‚úÖ Entregue Totalmente</option>
            </select>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
            <div>
                <label>Item:</label><input type="text" name="item" value="{{ pedido.item_comprado }}" required style="background: #f9f9f9;">
                <label>Fornecedor:</label><input type="text" name="fornecedor" value="{{ pedido.fornecedor }}" required style="background: #f9f9f9;">
                <label>Categoria:</label><input type="text" name="categoria" value="{{ pedido.categoria or '' }}" placeholder="Ex: Rolamento">
                
                <hr style="margin: 20px 0;">

                <label>N¬∫ Solicita√ß√£o:</label><input type="text" name="solicitacao" value="{{ pedido.numero_solicitacao }}" required>
                <label>N¬∫ Or√ßamento:</label><input type="text" name="orcamento" value="{{ pedido.numero_orcamento or '' }}">
                <label>N¬∫ Pedido:</label><input type="text" name="pedido" value="{{ pedido.numero_pedido or '' }}">
            </div>
            
            <div>
                <label>Data da Compra:</label><input type="date" name="data_compra" value="{{ pedido.data_compra or '' }}">
                
                <label>Prazo Original:</label><input type="date" name="prazo" value="{{ pedido.prazo_entrega or '' }}">
                <label style="color: #d35400;">Nova Data (se atrasou):</label><input type="date" name="reprogramada" value="{{ pedido.data_entrega_reprogramada or '' }}">
                
                <hr style="margin: 20px 0;">

                <label>Nota Fiscal:</label><input type="text" name="nota" value="{{ pedido.nota_fiscal or '' }}">
                <label>S√©rie:</label><input type="text" name="serie" value="{{ pedido.serie_nota or '' }}">
                
                <hr style="margin: 20px 0;">
                
                <label>Comprador Respons√°vel:</label>
                <select name="resp_comprador">
                    <option value="">-- Selecione o Comprador --</option>
                    {% for u in usuarios %}
                        <option value="{{ u.id }}" {% if pedido.id_comprador_responsavel|string == u.id|string %}selected{% endif %}>
                            {{ u.nome_completo }}
                        </option>
                    {% endfor %}
                </select>
                <span class="ajuda-campo">O respons√°vel por fazer a compra.</span>
                
                <label>Respons√°vel pelo Chamado:</label>
                <select name="resp_chamado">
                    <option value="">-- Selecione o Solicitante --</option>
                    {% for u in usuarios %}
                        <option value="{{ u.id }}" {% if pedido.id_responsavel_chamado|string == u.id|string %}selected{% endif %}>
                            {{ u.nome_completo }}
                        </option>
                    {% endfor %}
                </select>
                <span class="ajuda-campo">Quem abriu a solicita√ß√£o de compra.</span>
            </div>
            
            <div style="grid-column: 1 / -1;">
                <label>Coment√°rios / Observa√ß√µes:</label>
                <textarea name="observacao" rows="3" style="width: 100%; border: 2px solid #ccc; border-radius: 8px; padding: 10px; font-size: 1rem; margin-top: 8px;">{{ pedido.observacao or '' }}</textarea>
            </div>
        </div>
        
        <div style="margin-top: 30px; background: #e8f5e9; padding: 15px; border-radius: 8px;">
            <label style="margin-top: 0; color: var(--verde-sucesso);">Anexos Atuais ({{ anexos|length }}):</label>

            {% if anexos %}
                <div style="margin-bottom: 15px; border: 1px solid #c8e6c9; padding: 10px; background: #f0fff0; border-radius: 6px;">
                    {% for anexo in anexos %}
                        <div style="display: flex; gap: 10px; align-items: center; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #ddd;">
                            <a href="{{ url_for('static', filename='uploads/' + anexo.nome_arquivo) }}" target="_blank" style="font-weight: bold; font-size: 0.95rem;">
                                üìÑ {{ anexo.nome_original }}
                            </a>
                            <a href="#" onclick="return mostrarModal('{{ url_for('excluir_anexo', anexo_id=anexo.id) }}', 'anexo')" style="color: red; text-decoration: none; font-size: 0.9rem;">
                                üóëÔ∏è Apagar
                            </a>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p style="color: #666; font-style: italic;">Nenhum arquivo anexado ainda.</p>
            {% endif %}
            
            <label for="arquivo" style="display: block; margin-bottom: 10px;">Adicionar novo(s) arquivo(s):</label>
            <label for="arquivo" style="border: 2px dashed #999; background: white; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; display: block; margin-top: 0;">
                <span class="material-icons" style="font-size: 2rem; color: var(--azul-acao); display: block;">add_circle</span>
                <span id="texto-arquivo-edit" style="font-size: 1.1rem; color: #555;">Toque aqui para escolher novos arquivos</span>
            </label>
            <input type="file" id="arquivo" name="arquivo" accept=".pdf,.jpg,.jpeg,.png" multiple style="display: none;" onchange="mostrarNomeArquivoEdit()">
            <span class="ajuda-campo">Voc√™ pode selecionar um ou mais arquivos de uma vez.</span>

        </div>

        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <a href="{{ url_for('dashboard') }}" style="flex: 1; text-decoration: none;">
                <button type="button" style="background-color: #95a5a6; margin: 0;">Cancelar</button>
            </a>
            <button type="submit" style="flex: 2; background: var(--verde-sucesso); margin: 0;">
                üíæ Salvar Altera√ß√µes
            </button>
        </div>
    </form>
</div>

<script>
    // L√≥gica para dar feedback visual sobre a contagem de arquivos para a EDI√á√ÉO
    function mostrarNomeArquivoEdit() {
        var input = document.getElementById('arquivo');
        var texto = document.getElementById('texto-arquivo-edit');
        if (input.files && input.files.length > 0) {
            var count = input.files.length;
            texto.innerText = "‚úÖ " + count + " novo(s) arquivo(s) pronto(s) para upload";
            texto.style.fontWeight = "bold";
            texto.style.color = "var(--verde-sucesso)";
            texto.parentElement.style.borderColor = "var(--verde-sucesso)";
            texto.parentElement.style.backgroundColor = "#e8f5e9";
        } else {
             texto.innerText = "Toque aqui para escolher novos arquivos";
             texto.style.fontWeight = "";
             texto.style.color = "#555";
             texto.parentElement.style.borderColor = "#999";
             texto.parentElement.style.backgroundColor = "white";
        }
    }
</script>
{% endblock %}