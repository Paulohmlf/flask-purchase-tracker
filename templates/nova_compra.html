{% extends "base.html" %}

{% block content %}
<div class="card" style="max-width: 800px; margin: 0 auto; border-top: 6px solid var(--azul-acao);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; border: none;">ðŸ›’ LanÃ§ar Nova Compra</h2>
        <a href="{{ url_for('dashboard') }}" style="color: #e74c3c; font-weight: bold; font-size: 1.1rem; text-decoration: none;">
            âœ– Cancelar
        </a>
    </div>

    <p style="margin-bottom: 30px; color: #666;">Preencha as informaÃ§Ãµes abaixo em 3 passos simples.</p>

    <form method="POST" enctype="multipart/form-data">
        
        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #e9ecef;">
            <h3 style="color: var(--azul-acao); margin-top: 0;">1. O que vocÃª estÃ¡ comprando?</h3>
            
            <label>Item Comprado (O que Ã©?):</label>
            <input type="text" name="item" required placeholder="Ex: Computador Dell, Cadeira..." style="font-weight: bold;"
                value="{{ dados_form.get('item', '') }}">

            <label>Fornecedor (Quem vende?):</label>
            <input type="text" name="fornecedor" required placeholder="Ex: Kabum, Loja do ZÃ©..."
                value="{{ dados_form.get('fornecedor', '') }}">
            
            <label>Categoria (PeÃ§as, ServiÃ§o, Material de EscritÃ³rio...):</label>
            <input type="text" name="categoria" placeholder="Ex: Rolamento, Correia, TI"
                value="{{ dados_form.get('categoria', '') }}">

            <label>Para qual Unidade?</label>
            <select name="empresa" required style="height: 60px; font-size: 1.1rem;">
                <option value="" disabled {% if not dados_form.get('empresa') %}selected{% endif %}>â¬‡ Toque para selecionar a Loja</option>
                {% for emp in empresas %}
                    <option value="{{ emp.codi_empresa }}" 
                        {% if dados_form.get('empresa')|string == emp.codi_empresa|string %}selected{% endif %}>
                        {{ emp.nome_empresa }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div style="background-color: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #cfe2ff;">
            <h3 style="color: #004085; margin-top: 0;">2. NÃºmeros e Prazos</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div>
                    <label>NÂº SolicitaÃ§Ã£o :</label>
                    <input type="text" name="solicitacao" required placeholder="12345"
                        value="{{ dados_form.get('solicitacao', '') }}">
                </div>
                <div>
                    <label>NÂº OrÃ§amento :</label>
                    <input type="text" name="orcamento"
                        value="{{ dados_form.get('orcamento', '') }}">
                </div>
                <div>
                    <label>NÂº Pedido :</label>
                    <input type="text" name="pedido" placeholder="Ex: PED-999"
                        value="{{ dados_form.get('pedido', '') }}">
                </div>
                
                <div>
                    <label>Data da Compra:</label>
                    <input type="date" name="data_compra"
                        value="{{ dados_form.get('data_compra', '') }}">
                </div>
                <div>
                    <label>Prazo de Entrega (PrevisÃ£o):</label>
                    <input type="date" name="prazo"
                        value="{{ dados_form.get('prazo', '') }}">
                </div>
            </div>
            
            <label>ComentÃ¡rios/ObservaÃ§Ãµes (Detalhes importantes):</label>
            <textarea name="observacao" rows="3" style="width: 100%; border: 2px solid #ccc; border-radius: 8px; padding: 10px; font-size: 1rem; margin-top: 8px;">{{ dados_form.get('observacao', '') }}</textarea>

        </div>

        <div style="background-color: #fff8e1; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #ffeeba;">
            <h3 style="color: #856404; margin-top: 0;">3. Arquivo e ResponsÃ¡veis</h3>

            <label style="display: block; margin-bottom: 10px;">Tem anexo? (PDF ou Foto)</label>
            <label for="arquivo" style="border: 2px dashed #999; background: white; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; display: block; margin-top: 0;">
                <span class="material-icons" style="font-size: 2rem; color: var(--azul-acao); display: block;">cloud_upload</span>
                <span id="texto-arquivo" style="font-size: 1.1rem; color: #555;">Toque aqui para escolher o(s) arquivo(s)</span>
            </label>
            <input type="file" id="arquivo" name="arquivo" accept=".pdf,.jpg,.jpeg,.png" multiple style="display: none;" onchange="mostrarNomeArquivo()">
            <span class="ajuda-campo">VocÃª pode selecionar mais de um arquivo (PDF, JPG, PNG).</span>

            <div style="margin-top: 20px;">
                <label>Quem Ã© o Comprador responsÃ¡vel?</label>
                <select name="resp_comprador">
                    <option value="">-- Selecione o Comprador --</option>
                    {% for u in usuarios %}
                        <option value="{{ u.id }}" {% if dados_form.get('resp_comprador')|string == u.id|string %}selected{% endif %}>
                            {{ u.nome_completo }}
                        </option>
                    {% endfor %}
                </select>
                <span class="ajuda-campo">O responsÃ¡vel por fazer a compra.</span>
            </div>
            
            <div style="margin-top: 20px;">
                <label>ResponsÃ¡vel pelo Chamado:</label>
                <select name="resp_chamado">
                    <option value="">-- Selecione o Solicitante --</option>
                    {% for u in usuarios %}
                        <option value="{{ u.id }}" {% if dados_form.get('resp_chamado')|string == u.id|string %}selected{% endif %}>
                            {{ u.nome_completo }}
                        </option>
                    {% endfor %}
                </select>
                <span class="ajuda-campo">Quem Ã© responsavel pelo chamado.</span>
            </div>

            <div style="margin-top: 20px;">
                <label>SituaÃ§Ã£o Inicial:</label>
                <select name="status" style="font-weight: bold; color: #333;">
                    <option value="Aguardando AprovaÃ§Ã£o" {% if dados_form.get('status') == 'Aguardando AprovaÃ§Ã£o' %}selected{% endif %}>ðŸŸ¡ Aguardando AprovaÃ§Ã£o</option>
                    <option value="Enviado ao Fornecedor" {% if dados_form.get('status') == 'Enviado ao Fornecedor' %}selected{% endif %}>ðŸ”µ Enviado ao Fornecedor</option>
                    <option value="Confirmado" {% if dados_form.get('status') == 'Confirmado' %}selected{% endif %}>ðŸŸ¢ Confirmado</option>
                </select>
            </div>
        </div>

        <button type="submit" style="background-color: var(--verde-sucesso); font-size: 1.4rem; padding: 20px;">
            ðŸ’¾ Salvar Pedido
        </button>
    </form>
</div>

<script>
    // LÃ³gica para dar feedback visual sobre a contagem de arquivos escolhidos
    function mostrarNomeArquivo() {
        var input = document.getElementById('arquivo');
        var texto = document.getElementById('texto-arquivo');
        if (input.files && input.files.length > 0) {
            var count = input.files.length;
            texto.innerText = "âœ… " + count + " arquivo(s) selecionado(s)";
            texto.style.fontWeight = "bold";
            texto.style.color = "var(--verde-sucesso)";
            texto.parentElement.style.borderColor = "var(--verde-sucesso)";
            texto.parentElement.style.backgroundColor = "#e8f5e9";
        } else {
             texto.innerText = "Toque aqui para escolher o(s) arquivo(s)";
             texto.style.fontWeight = "";
             texto.style.color = "#555";
             texto.parentElement.style.borderColor = "#999";
             texto.parentElement.style.backgroundColor = "white";
        }
    }
</script>
{% endblock %}