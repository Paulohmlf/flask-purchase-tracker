{% extends "base.html" %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 0 auto; border-top: 6px solid var(--azul-acao);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; border: none;">ðŸ›’ LanÃ§ar Nova Compra (MÃºltiplos Itens)</h2>
        <a href="{{ url_for('dashboard') }}" style="color: #e74c3c; font-weight: bold; font-size: 1.1rem; text-decoration: none;">
            âœ– Cancelar
        </a>
    </div>

    <p style="margin-bottom: 30px; color: #666;">Preencha as informaÃ§Ãµes do pedido abaixo.</p>

    <form method="POST" enctype="multipart/form-data" id="form-compra">
        
        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #e9ecef;">
            <h3 style="color: var(--azul-acao); margin-top: 0;">1. Lista de Produtos</h3>
            
            <div style="display: grid; grid-template-columns: 4fr 1fr 1fr 0.5fr; gap: 10px; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.9rem;">
                <div>DescriÃ§Ã£o do Item *</div>
                <div>Qtd. *</div>
                <div>Unidade</div>
                <div></div>
            </div>

            <div id="lista-itens">
                <div class="linha-item" style="display: grid; grid-template-columns: 4fr 1fr 1fr 0.5fr; gap: 10px; margin-bottom: 10px; align-items: center;">
                    
                    <input type="text" name="nome_item[]" required placeholder="Ex: Caneta Azul" style="font-weight: bold;">
                    
                    <input type="number" name="qtd[]" required min="1" value="1" style="text-align: center;">
                    
                    <select name="unidade[]" style="padding: 10px;">
                        <option value="UN">UN</option>
                        <option value="CX">CX</option>
                        <option value="PCT">PCT</option>
                        <option value="KG">KG</option>
                        <option value="M">M</option>
                        <option value="L">L</option>
                    </select>

                    <button type="button" onclick="removerItem(this)" style="background: #fab1a0; color: #c0392b; padding: 10px; margin: 0; display: none;">
                        âœ–
                    </button>
                </div>
            </div>

            <button type="button" onclick="adicionarItem()" style="background-color: #3498db; width: 100%; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <span class="material-icons">add_circle</span> Adicionar Outro Item
            </button>
            
            <hr style="margin: 20px 0;">

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <label>Fornecedor (Quem vende?):</label>
                    <input type="text" name="fornecedor" required placeholder="Ex: Kalunga" value="{{ dados_form.get('fornecedor', '') }}">
                </div>
                <div>
                    <label>Categoria Principal:</label>
                    <input type="text" name="categoria" placeholder="Ex: Material de EscritÃ³rio" value="{{ dados_form.get('categoria', '') }}">
                </div>
            </div>

            <label style="margin-top: 15px; display: block;">Para qual Unidade?</label>
            <select name="empresa" required style="height: 50px; font-size: 1rem;">
                <option value="" disabled {% if not dados_form.get('empresa') %}selected{% endif %}>â¬‡ Selecione a Loja</option>
                {% for emp in empresas %}
                    <option value="{{ emp.codi_empresa }}" {% if dados_form.get('empresa')|string == emp.codi_empresa|string %}selected{% endif %}>
                        {{ emp.nome_empresa }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div style="background-color: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #cfe2ff;">
            <h3 style="color: #004085; margin-top: 0;">2. NÃºmeros e Prazos</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div>
                    <label>NÂº SolicitaÃ§Ã£o :</label>
                    <input type="text" name="solicitacao" required placeholder="12345" value="{{ dados_form.get('solicitacao', '') }}">
                </div>
                <div>
                    <label>NÂº OrÃ§amento :</label>
                    <input type="text" name="orcamento" value="{{ dados_form.get('orcamento', '') }}">
                </div>
                <div>
                    <label>NÂº Pedido :</label>
                    <input type="text" name="pedido" placeholder="Ex: PED-999" value="{{ dados_form.get('pedido', '') }}">
                </div>
                
                <div>
                    <label>Data da Compra:</label>
                    <input type="date" name="data_compra" value="{{ dados_form.get('data_compra', '') }}">
                </div>
                <div>
                    <label>Prazo de Entrega:</label>
                    <input type="date" name="prazo" value="{{ dados_form.get('prazo', '') }}">
                </div>
            </div>
            
            <label>ObservaÃ§Ãµes:</label>
            <textarea name="observacao" rows="3" style="width: 100%; border: 2px solid #ccc; border-radius: 8px; padding: 10px; margin-top: 8px;">{{ dados_form.get('observacao', '') }}</textarea>
        </div>

        <div style="background-color: #fff8e1; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #ffeeba;">
            <h3 style="color: #856404; margin-top: 0;">3. Arquivo e ResponsÃ¡veis</h3>

            <label style="display: block; margin-bottom: 10px;">Anexos (PDF ou Foto)</label>
            <label for="arquivo" style="border: 2px dashed #999; background: white; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; display: block; margin-top: 0;">
                <span class="material-icons" style="font-size: 2rem; color: var(--azul-acao); display: block;">cloud_upload</span>
                <span id="texto-arquivo" style="font-size: 1.1rem; color: #555;">Toque aqui para escolher arquivos</span>
            </label>
            <input type="file" id="arquivo" name="arquivo" accept=".pdf,.jpg,.jpeg,.png" multiple style="display: none;" onchange="mostrarNomeArquivo()">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div>
                    <label>Responsavel pela Compra:</label>
                    <select name="resp_comprador">
                        <option value="">-- Selecione --</option>
                        {% for u in usuarios %}
                            <option value="{{ u.id }}" {% if dados_form.get('resp_comprador')|string == u.id|string %}selected{% endif %}>{{ u.nome_completo }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label>Responsavel pela SolicitaÃ§Ã£o:</label>
                    <select name="resp_chamado">
                        <option value="">-- Selecione --</option>
                        {% for u in usuarios %}
                            <option value="{{ u.id }}" {% if dados_form.get('resp_chamado')|string == u.id|string %}selected{% endif %}>{{ u.nome_completo }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <label>SituaÃ§Ã£o Inicial:</label>
                <select name="status" style="font-weight: bold; color: #333;">
                    <option value="Aguardando AprovaÃ§Ã£o">ðŸŸ¡ Aguardando AprovaÃ§Ã£o</option>
                    <option value="OrÃ§amento">ðŸ”µ OrÃ§amento</option>
                    <option value="Confirmado">ðŸŸ¢ Confirmado</option>
                </select>
            </div>
        </div>

        <button type="submit" style="background-color: var(--verde-sucesso); font-size: 1.4rem; padding: 20px; width: 100%;">
            ðŸ’¾ Salvar Pedido Completo
        </button>
    </form>
</div>

<script>
    // 1. FunÃ§Ã£o para adicionar nova linha de item
    function adicionarItem() {
        const container = document.getElementById('lista-itens');
        // Clona a primeira linha
        const primeiraLinha = container.querySelector('.linha-item');
        const novaLinha = primeiraLinha.cloneNode(true);
        
        // Limpa os valores dos inputs clonados
        const inputs = novaLinha.querySelectorAll('input');
        inputs.forEach(input => input.value = '');
        inputs[1].value = 1; // Reseta quantidade para 1 (O Ã­ndice 1 Ã© a quantidade, pois Ã­ndice 0 Ã© o nome)
        
        // Mostra o botÃ£o de excluir na nova linha
        const btnRemover = novaLinha.querySelector('button');
        btnRemover.style.display = 'block';

        container.appendChild(novaLinha);
    }

    // 2. FunÃ§Ã£o para remover linha
    function removerItem(botao) {
        const linha = botao.parentElement;
        linha.remove();
    }

    // 3. Feedback visual de Arquivos
    function mostrarNomeArquivo() {
        var input = document.getElementById('arquivo');
        var texto = document.getElementById('texto-arquivo');
        if (input.files && input.files.length > 0) {
            texto.innerText = "âœ… " + input.files.length + " arquivo(s) selecionado(s)";
            texto.style.color = "var(--verde-sucesso)";
            texto.style.fontWeight = "bold";
        } else {
             texto.innerText = "Toque aqui para escolher arquivos";
             texto.style.color = "#555";
             texto.style.fontWeight = "normal";
        }
    }
</script>

<style>
    @media (max-width: 600px) {
        .linha-item {
            grid-template-columns: 1fr 1fr !important; /* Em celular, quebra em 2 colunas */
            border-bottom: 2px dashed #ddd;
            padding-bottom: 10px;
        }
        .linha-item input[name="nome_item[]"] {
            grid-column: span 2; /* Nome do item ocupa a largura toda */
        }
    }
</style>
{% endblock %}