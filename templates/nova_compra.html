{% extends "base.html" %}

{% block content %}
<div class="card" style="max-width: 1200px; margin: 0 auto; border-top: 6px solid var(--azul-acao);">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="margin: 0; border: none; font-size: 1.8rem; color: #2c3e50;">ðŸ›’ LanÃ§ar Nova Compra</h1>
        <a href="{{ url_for('dashboard') }}" style="color: #c0392b; font-weight: bold; font-size: 1.1rem; text-decoration: none;">
            âœ– Cancelar
        </a>
    </div>

    <div style="background: #e3f2fd; border: 2px dashed #1565c0; padding: 15px; border-radius: 8px; margin-bottom: 30px; text-align: center;">
        <form action="{{ url_for('importar_solicitacao') }}" method="POST" enctype="multipart/form-data" id="form-importar" style="display: flex; align-items: center; justify-content: center; gap: 15px;">
            <label for="pdf_import" style="cursor: pointer; color: #0d47a1; font-weight: bold; display: flex; align-items: center; gap: 5px;">
                <span class="material-icons">picture_as_pdf</span> 
                Importar SolicitaÃ§Ã£o (PDF)
            </label>
            <input type="file" name="arquivo_pdf" id="pdf_import" accept=".pdf" required style="font-size: 0.9rem;">
            
            <button type="submit" form="form-importar" style="background: #1565c0; color: white; padding: 8px 15px; margin: 0; font-size: 0.9rem;">
                Carregar Dados âš¡
            </button>
        </form>
        <p style="margin: 5px 0 0 0; font-size: 0.8rem; color: #444;">Carregue o PDF da Yale/Nutrane para preencher automaticamente.</p>
    </div>

    <form method="POST" enctype="multipart/form-data" id="form-compra" action="{{ url_for('nova_compra') }}">
        
        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #e9ecef;">
            <h2 style="color: var(--azul-acao); margin-top: 0; font-size: 1.4rem;">1. Lista de Produtos</h2>
            
            <div style="display: grid; grid-template-columns: 3fr 1fr 1fr 1fr 0.5fr; gap: 10px; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.9rem;">
                <div>DescriÃ§Ã£o do Item *</div>
                <div>Qtd. *</div>
                <div>Unid.</div>
                <div>Valor Unit. (R$)</div>
                <div></div>
            </div>

            <div id="lista-itens">
                {% if itens_preenchidos %}
                    {% for item in itens_preenchidos %}
                    <div class="linha-item" style="display: grid; grid-template-columns: 3fr 1fr 1fr 1fr 0.5fr; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <input type="text" name="nome_item[]" value="{{ item.nome_item }}" required style="font-weight: bold;" aria-label="DescriÃ§Ã£o do Item">
                        <input type="number" name="qtd[]" value="{{ item.quantidade }}" required min="1" style="text-align: center;" aria-label="Quantidade">
                        
                        <select name="unidade[]" style="padding: 10px;" aria-label="Unidade de Medida">
                            <option value="UN" {% if item.unidade_medida == 'UN' %}selected{% endif %}>UN</option>
                            <option value="CX" {% if item.unidade_medida == 'CX' %}selected{% endif %}>CX</option>
                            <option value="PCT" {% if item.unidade_medida == 'PCT' %}selected{% endif %}>PCT</option>
                            <option value="KG" {% if item.unidade_medida == 'KG' %}selected{% endif %}>KG</option>
                            <option value="M" {% if item.unidade_medida == 'M' %}selected{% endif %}>M</option>
                            <option value="L" {% if item.unidade_medida == 'L' %}selected{% endif %}>L</option>
                        </select>

                        <input type="number" step="0.01" name="valor[]" placeholder="0,00" style="text-align: right;"> 
                        
                        <button type="button" onclick="removerItem(this)" style="background: #fab1a0; color: #c0392b; padding: 10px; margin: 0;" aria-label="Remover item da lista">âœ–</button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="linha-item" style="display: grid; grid-template-columns: 3fr 1fr 1fr 1fr 0.5fr; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <input type="text" name="nome_item[]" required placeholder="Ex: Caneta Azul" style="font-weight: bold;" aria-label="DescriÃ§Ã£o do Item">
                        <input type="number" name="qtd[]" required min="1" value="1" style="text-align: center;" aria-label="Quantidade">
                        <select name="unidade[]" style="padding: 10px;" aria-label="Unidade de Medida">
                            <option value="UN">UN</option>
                            <option value="CX">CX</option>
                            <option value="PCT">PCT</option>
                            <option value="KG">KG</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                        </select>
                        <input type="number" step="0.01" name="valor[]" placeholder="0,00" style="text-align: right;">
                        <button type="button" onclick="removerItem(this)" style="background: #fab1a0; color: #c0392b; padding: 10px; margin: 0; display: none;" aria-label="Remover item da lista">âœ–</button>
                    </div>
                {% endif %}
            </div>

            <button type="button" onclick="adicionarItem()" style="background-color: #3498db; width: 100%; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <span class="material-icons">add_circle</span> Adicionar Outro Item
            </button>
            
            <hr style="margin: 20px 0;">

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <label for="id_fornecedor">Fornecedor (Quem vende?):</label>
                    <input type="text" id="id_fornecedor" name="fornecedor" required placeholder="Ex: Kalunga" value="{{ dados_form.get('fornecedor', '') }}">
                </div>
                <div>
                    <label for="id_categoria">Categoria Principal:</label>
                    <input type="text" id="id_categoria" name="categoria" placeholder="Ex: PeÃ§as" value="{{ dados_form.get('categoria', '') }}">
                </div>
            </div>

            <label for="id_empresa" style="margin-top: 15px; display: block;">Para qual Unidade?</label>
            <select id="id_empresa" name="empresa" required style="height: 50px; font-size: 1rem;">
                <option value="" disabled {% if not dados_form.get('empresa') %}selected{% endif %}>â¬‡ Selecione a Loja</option>
                {% for emp in empresas %}
                    <option value="{{ emp.codi_empresa }}" 
                        {% if dados_form.get('empresa')|string == emp.codi_empresa|string %}selected{% endif %}>
                        {{ emp.nome_empresa }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div style="background-color: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #cfe2ff;">
            <h2 style="color: #004085; margin-top: 0; font-size: 1.4rem;">2. NÃºmeros e Prazos</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div>
                    <label for="id_solicitacao">NÂº SolicitaÃ§Ã£o :</label>
                    <input type="text" id="id_solicitacao" name="solicitacao" required placeholder="12345" value="{{ dados_form.get('solicitacao', '') }}">
                </div>
                <div>
                    <label for="id_orcamento">NÂº OrÃ§amento :</label>
                    <input type="text" id="id_orcamento" name="orcamento" value="{{ dados_form.get('orcamento', '') }}">
                </div>
                <div>
                    <label for="id_pedido">NÂº Pedido :</label>
                    <input type="text" id="id_pedido" name="pedido" placeholder="Ex: PED-999" value="{{ dados_form.get('pedido', '') }}">
                </div>
                
                <div>
                    <label for="id_data_compra">Data da Compra:</label>
                    <input type="date" id="id_data_compra" name="data_compra" value="{{ dados_form.get('data_compra', '') }}">
                </div>
                <div>
                    <label for="id_prazo">Prazo de Entrega:</label>
                    <input type="date" id="id_prazo" name="prazo" value="{{ dados_form.get('prazo', '') }}">
                </div>
            </div>
            
            <label for="id_observacao">ObservaÃ§Ãµes:</label>
            <textarea id="id_observacao" name="observacao" rows="3" style="width: 100%; border: 2px solid #ccc; border-radius: 8px; padding: 10px; margin-top: 8px;">{{ dados_form.get('observacao', '') }}</textarea>
        </div>

        <div style="background-color: #fff8e1; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #ffeeba;">
            <h2 style="color: #856404; margin-top: 0; font-size: 1.4rem;">3. Arquivo e ResponsÃ¡veis</h2>

            <h3 style="display: block; margin-bottom: 10px; font-weight: bold; color: #333; margin-top: 0; font-size: 1.1rem;">Anexos (PDF ou Foto)</h3>
            
            <label for="arquivo" style="border: 2px dashed #999; background: white; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; display: block; margin-top: 0;">
                <span class="material-icons" style="font-size: 2rem; color: var(--azul-acao); display: block;">cloud_upload</span>
                <span id="texto-arquivo" style="font-size: 1.1rem; color: #555;">Toque aqui para escolher arquivos</span>
            </label>
            <input type="file" id="arquivo" name="arquivo" accept=".pdf,.jpg,.jpeg,.png" multiple style="display: none;" onchange="mostrarNomeArquivo()">
            
            <div style="margin-top: 20px;">
                <label for="id_solicitante_real">Solicitante Real (Quem pediu lÃ¡ na ponta?):</label>
                <input type="text" id="id_solicitante_real" name="solicitante_real" placeholder="Ex: Zezinho da Bahia" 
                       value="{{ dados_form.get('solicitante_real', '') }}" 
                       style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div>
                    <label for="id_resp_comprador">ResponsÃ¡vel pela Compra (Sistema):</label>
                    <select id="id_resp_comprador" name="resp_comprador">
                        <option value="">-- Selecione --</option>
                        {% for u in usuarios %}
                            <option value="{{ u.id }}" {% if dados_form.get('resp_comprador')|string == u.id|string %}selected{% endif %}>{{ u.nome_completo }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="id_resp_chamado">ResponsÃ¡vel pela SolicitaÃ§Ã£o (Sistema):</label>
                    <select id="id_resp_chamado" name="resp_chamado">
                        <option value="">-- Selecione --</option>
                        {% for u in usuarios %}
                            <option value="{{ u.id }}" {% if dados_form.get('resp_chamado')|string == u.id|string %}selected{% endif %}>{{ u.nome_completo }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <label for="id_status">SituaÃ§Ã£o Inicial:</label>
                <select id="id_status" name="status" style="font-weight: bold; color: #333;">
                    <option value="Aguardando AprovaÃ§Ã£o">ðŸŸ¡ Aguardando AprovaÃ§Ã£o</option>
                    <option value="OrÃ§amento">ðŸŸ£ OrÃ§amento</option>
                    <option value="Confirmado">ðŸŸ¢ Confirmado</option>
                </select>
            </div>
        </div>

        <button type="submit" form="form-compra" style="background-color: var(--verde-sucesso); font-size: 1.4rem; padding: 20px; width: 100%;">
            ðŸ’¾ Salvar Pedido Completo
        </button>
    </form>
</div>

<template id="template-novo-item">
    <div class="linha-item" style="display: grid; grid-template-columns: 3fr 1fr 1fr 1fr 0.5fr; gap: 10px; margin-bottom: 10px; align-items: center;">
        <input type="text" name="nome_item[]" placeholder="Nome do Item" required style="font-weight: bold;" aria-label="DescriÃ§Ã£o do Item">
        <input type="number" name="qtd[]" value="1" required min="1" style="text-align: center;" aria-label="Quantidade">
        <select name="unidade[]" style="padding: 10px;" aria-label="Unidade de Medida">
            <option value="UN">UN</option>
            <option value="CX">CX</option>
            <option value="PCT">PCT</option>
            <option value="KG">KG</option>
            <option value="M">M</option>
            <option value="L">L</option>
        </select>
        <input type="number" step="0.01" name="valor[]" placeholder="0,00" style="text-align: right;">
        <button type="button" onclick="removerItemNovo(this)" style="background: #fab1a0; color: #c0392b; padding: 10px; margin: 0;" aria-label="Remover item da lista">âœ–</button>
    </div>
</template>

<script>
    function adicionarItem() {
        const container = document.getElementById('lista-itens');
        const template = document.getElementById('template-novo-item');
        const clone = template.content.cloneNode(true);
        container.appendChild(clone);
    }
    function removerItemNovo(btn) { btn.parentElement.remove(); }
    function removerItem(btn) { btn.parentElement.remove(); }
    function mostrarNomeArquivo() {
        var input = document.getElementById('arquivo');
        var texto = document.getElementById('texto-arquivo');
        if (input.files && input.files.length > 0) {
            texto.innerText = "âœ… " + input.files.length + " arquivo(s) selecionado(s)";
            texto.style.color = "var(--verde-sucesso)";
            texto.style.fontWeight = "bold";
        }
    }

    // --- CÃ“DIGO DO ENTER ---
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById("form-compra");
        form.addEventListener("keydown", function(e) {
            if (e.key === "Enter") {
                const target = e.target;
                if (target.tagName === "TEXTAREA") return;
                if (target.type === "submit" || target.tagName === "BUTTON") return;
                e.preventDefault();
                const inputs = Array.from(form.querySelectorAll("input:not([type=hidden]):not([disabled]), select:not([disabled])"));
                const index = inputs.indexOf(target);
                if (index > -1 && index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }
            }
        });
    });
</script>

<style>
    @media (max-width: 600px) {
        .linha-item { grid-template-columns: 1fr 1fr !important; border-bottom: 2px dashed #ddd; padding-bottom: 10px; }
        .linha-item input[name="nome_item[]"] { grid-column: span 2; }
    }
</style>
{% endblock %}